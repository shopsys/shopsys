on:
    schedule:
        -   cron: '0 3 * * *'
name: Rebuild Docker images
jobs:
    rebuild-master-images:
        name: Rebuild ${{ matrix.branches }} branch Docker images in GitHub Container Registry
        runs-on: ubuntu-20.04
        strategy:
            matrix:
                branches: ['master', '9.1', '10.0', '11.0', '12.0']
            fail-fast: false
        permissions:
            contents: read
            packages: write
        steps:
            -   name: GIT checkout branch - refs/heads/${{ matrix.branches }}
                uses: actions/checkout@v3
                with:
                    ref: refs/heads/${{ matrix.branches }}
            -   name: Login to GitHub Container Registry
                uses: docker/login-action@v2
                with:
                    registry: ghcr.io
                    username: ${{ github.actor }}
                    password: ${{ secrets.GITHUB_TOKEN }}
            -   name: Generate PHP-FPM tag
                env:
                    DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
                run: |
                    DOCKER_PHP_FPM_IMAGE_TAG=github-action-`find project-base/app/docker/php-fpm -type f -exec stat -c "%a %n" {} \; -exec cat {} \; | md5sum | awk '{ print $1 }'`
                    echo "DOCKER_PHP_FPM_IMAGE_TAG=${DOCKER_PHP_FPM_IMAGE_TAG}" >> $GITHUB_ENV
                    echo "DOCKER_USERNAME=${DOCKER_USERNAME}" >> $GITHUB_ENV
            -   name: Build PHP-FPM image and push it to GitHub Container Registry
                run: |
                    DOCKER_PHP_FPM_REPOSITORY_TAG=ghcr.io/${DOCKER_USERNAME}/php-fpm:${DOCKER_PHP_FPM_IMAGE_TAG}
                    .github/build-php-fpm-image.sh ${DOCKER_PHP_FPM_REPOSITORY_TAG}
                    docker image push ${DOCKER_PHP_FPM_REPOSITORY_TAG}
            -   name: Generate Elasticseach tag
                run: |
                    DOCKER_ELASTICSEARCH_IMAGE_TAG=github-action-`find project-base/app/docker/elasticsearch -type f -exec stat -c "%a %n" {} \; -exec cat {} \; | md5sum | awk '{ print $1 }'`
                    echo "DOCKER_ELASTICSEARCH_IMAGE_TAG=${DOCKER_ELASTICSEARCH_IMAGE_TAG}" >> $GITHUB_ENV
            -   name: Build Elasticsearch image and push it to GitHub Container Registry
                env:
                    DOCKER_ELASTICSEARCH_REPOSITORY_TAG:
                run: |
                    DOCKER_ELASTICSEARCH_REPOSITORY_TAG=ghcr.io/${DOCKER_USERNAME}/elasticsearch:${DOCKER_ELASTICSEARCH_IMAGE_TAG}
                    .github/build-elasticsearch-image.sh ${DOCKER_ELASTICSEARCH_REPOSITORY_TAG}
                    docker image push ${DOCKER_ELASTICSEARCH_REPOSITORY_TAG}
