stages:
-   Build
-   Tests

cache:
    timeout: 172800
    directories:
    -   $CACHE_DIR

env:
    global:
    -   CACHE_DIR=$HOME/.cache/docker
    -   CACHE_FILE_IMAGE=$CACHE_DIR/php-fpm.tar.gz
    -   DOCKER_COMPOSE_VERSION=1.8.0

before_install:
-   sudo apt-get install -o Dpkg::Options::="--force-confold" --force-yes -y do
-   docker-compose --version
jobs:
    include:
    -   stage: Build
        before_script:
        -   mkdir -p $CACHE_DIR
        script:
        -   docker image build
              --build-arg project_root=project-base
              --tag php-fpm
              --target production
              --cache-from php-fpm
              -f project-base/docker/php-fpm/Dockerfile . &&
            docker save php-fpm | gzip > ${CACHE_FILE_IMAGE}
    -   stage: Tests
        name: Standards
        script: docker run --rm php-fpm php phing composer-dev standards
    -   name: Unit tests
        script: docker run --rm php-fpm php phing composer-dev tests-static
    -   name: Functional and Smoke tests
        script:
        -   docker run
              --add-host postgres:127.0.0.1
              --add-host elasticsearch:127.0.0.1
              --add-host redis:127.0.0.1
              --network=host
              --rm php-fpm php phing travis-tests-functional
